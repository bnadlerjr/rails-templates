#!/usr/bin/env ruby
require 'fileutils'
include FileUtils

# path to your application root.
APP_ROOT = File.expand_path('..', __dir__)
VENDOR_ASSETS = [
  'admin-lte/2.4.8/css/AdminLTE.css',
  'admin-lte/2.4.8/css/skins/skin-blue.css',
  'admin-lte/2.4.8/js/adminlte.js',
  'font-awesome/4.7.0/css/font-awesome.css',
  'font-awesome/4.7.0/fonts/fontawesome-webfont.eot',
  'font-awesome/4.7.0/fonts/fontawesome-webfont.svg',
  'font-awesome/4.7.0/fonts/fontawesome-webfont.ttf',
  'font-awesome/4.7.0/fonts/fontawesome-webfont.woff',
  'font-awesome/4.7.0/fonts/fontawesome-webfont.woff2',
  'jquery/1.9.1/jquery.js',
  'twitter-bootstrap/3.4.0/css/bootstrap.css',
  'twitter-bootstrap/3.4.0/js/bootstrap.js'
]

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file.

  puts '== Installing dependencies =='
  system! 'gem install bundler --conservative'
  system('bundle check') || system!('bundle install')
  system('bin/yarn')

  puts '== Retrieving Vendored Assets =='
  VENDOR_ASSETS.each do |file|
    puts "\nRetrieving #{file}..."
    system!("curl --progress-bar --create-dirs --output ./vendor/assets/themes/#{file} https://cdnjs.cloudflare.com/ajax/libs/#{file}")
  end

  puts "\n== Copying sample files =="
  unless File.exist?('.env')
    cp 'example.env', '.env'
  end
  unless File.exist?('config/database.yml')
    cp 'config/database.yml.sample', 'config/database.yml'
  end

  puts "\n== Preparing database =="
  system! 'bin/rails db:setup'
  system! 'bin/rails db:create:all'
  system! 'bin/rails db:migrate'
  system! 'bin/rails db:seed'

  puts "\n== Removing old logs and tempfiles =="
  system! 'bin/rails log:clear tmp:clear'
end
